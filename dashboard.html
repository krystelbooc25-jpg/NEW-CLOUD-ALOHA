<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALOHA Admin Pro | 2026 Modern Dashboard</title>
    
    <!-- 1. EXTERNAL RESOURCES -->
    <!-- Google Fonts: Plus Jakarta Sans is the standard for 2026 professional UIs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 for Layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 for Modern Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Dashboard.css">
    
    <!-- Heavy Libraries for Data and Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 2. BRANDING & THEME VARIABLES --- */
        
    </style>
</head>
<body>

    <!-- 10. NOTIFICATION & SYSTEM MODALS -->
    <!-- Confirmation Dialog (Delete, Logout, Restore) -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalIcon" style="font-size: 80px; color: var(--primary-red); margin-bottom: 30px;"><i class="fas fa-circle-exclamation"></i></div>
            <h2 id="modalTitle" style="font-weight: 800; color: var(--dark-slate); letter-spacing: -0.5px;">System Alert</h2>
            <p id="modalText" style="color: var(--text-muted); margin: 20px 0 40px; line-height: 1.7; font-size: 1.1rem;">Please confirm your action.</p>
            <div class="d-flex justify-content-center gap-3">
                <button id="cancelBtn" class="btn btn-light px-5 py-3 fw-bold" style="border-radius: 18px; border: 1px solid #e2e8f0;">Cancel</button>
                <button id="confirmBtn" class="btn btn-danger px-5 py-3 fw-bold" style="background: var(--primary-red); border-radius: 18px; border: none; box-shadow: 0 10px 25px rgba(210, 4, 45, 0.2);">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Personnel Registration Modal -->
    <div id="manualAddModal" class="modal-overlay">
        <div class="modal-box text-start" style="max-width: 550px;">
            <h2 class="mb-4 text-center" style="color: var(--dark-slate); font-weight: 800; letter-spacing: -1px;">New Registration</h2>
            <div class="mb-3">
                <label class="form-label fw-bold small text-muted text-uppercase">Given Name</label>
                <input type="text" id="m_first_name" class="form-control" placeholder="Type first name...">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small text-muted text-uppercase">Surname</label>
                <input type="text" id="m_last_name" class="form-control" placeholder="Type last name...">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small text-muted text-uppercase">Designated Role</label>
                <select id="m_position" class="form-select">
                    <option value="Security Guard">Security Guard</option>
                    <option value="Security Supervisor">Security Supervisor</option>
                    <option value="Mobile Patrol">Mobile Patrol</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold small text-muted text-uppercase">Deployment Branch</label>
                <select id="m_branch" class="form-select">
                    <option value="">Stay in Pending Queue</option>
                    <option value="Manila Main">Manila Main</option>
                    <option value="Quezon City">Quezon City</option>
                    <option value="Makati Hub">Makati Hub</option>
                    <option value="Davao Branch">Davao Branch</option>
                    <option value="Cebu Office">Cebu Office</option>
                </select>
            </div>
            <div class="d-flex justify-content-center gap-3">
                <button onclick="closeManualAdd()" class="btn btn-light w-50 py-3 fw-bold" style="border-radius: 18px;">Close</button>
                <button onclick="saveManualEmployee()" class="btn btn-danger w-50 py-3 fw-bold" style="background: var(--primary-red); border-radius: 18px; border: none;">Save Personnel</button>
            </div>
        </div>
    </div>

    <!-- 11. SIDEBAR STRUCTURE -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-card-wrapper">
            <div class="logo-card">
                <div class="logo-img-container">
                    <img src="Resources/logo.jpg" alt="Logo">
                </div>
                <div class="logo-details">
                    <h2 class="logo-title">ALOHA <span>ADMIN</span></h2>
                    <p class="logo-subtitle">Security Control Panel</p>
                </div>
            </div>
        </div>

        <div class="nav-label">Main Menu</div>
        <div class="nav-item active" data-title="Dashboard" data-tab="dashboard-tab" onclick="switchTab('dashboard-tab', this)"><i class="fas fa-th-large"></i> Dashboard</div>
        <div class="nav-item" data-title="Audit Logs" data-tab="audit-tab" onclick="switchTab('audit-tab', this)"><i class="fas fa-clipboard-list"></i> Audit Logs</div>

        <div class="nav-label">Operations</div>
        <div class="nav-item" data-title="Applicants" data-tab="applicants-tab" onclick="switchTab('applicants-tab', this)"><i class="fas fa-user-shield"></i> Applicants</div>
        <div class="nav-item" data-title="Active Roster" data-tab="branches-tab" onclick="switchTab('branches-tab', this)"><i class="fas fa-users"></i> Active Roster</div>
        <div class="nav-item" data-title="Branches" data-tab="branch-summary-tab" onclick="switchTab('branch-summary-tab', this)"><i class="fas fa-building"></i> Branches</div>
        <div class="nav-item" data-title="Trash Bin" data-tab="trash-tab" onclick="switchTab('trash-tab', this)"><i class="fas fa-trash-alt"></i> Trash Bin</div>
        <div class="nav-item" data-title="Blacklisted" data-tab="blacklist-tab" onclick="switchTab('blacklist-tab', this)"><i class="fas fa-user-slash"></i> Blacklisted</div>

        <div class="nav-label">System</div>
        <div class="nav-item" data-title="Users" data-tab="users-tab" onclick="switchTab('users-tab', this)"><i class="fas fa-user-cog"></i> Users</div>
        <div class="nav-item" data-title="Settings" data-tab="settings-tab" onclick="switchTab('settings-tab', this)"><i class="fas fa-gear"></i> Settings</div>

        <div class="admin-session-card">
            <small>Logged in as</small>
            <strong>admin</strong>
            <span><i class="fas fa-shield-heart"></i> Owner</span>
        </div>

        <div style="margin-top: auto; padding: 0 16px 20px;">
            <button class="sidebar-logout-btn" onclick="handleLogout()"><i class="fas fa-right-from-bracket"></i> Logout</button>
        </div>
    </aside>

    <!-- 12. MAIN CONTENT INTERFACE -->
    <main class="main-content">
        <!-- Persistent Header Bar -->
        <header class="header-bar">
            
            <h3 id="current-title" style="color: var(--dark-slate); font-weight: 800; margin: 0; letter-spacing: -1px;">DASHBOARD</h3>
            
            <div class="d-flex align-items-center">
                <!-- Notifications Bell -->
                <div class="dropdown me-4">
                    <div class="notification-wrapper" style="cursor: pointer; position: relative; padding: 12px; background: #f1f5f9; border-radius: 16px;" data-bs-toggle="dropdown">
                        <i class="fas fa-bell fs-5 text-secondary"></i>
                        <span id="notif-badge" class="badge rounded-circle bg-danger position-absolute" style="top: 8px; right: 8px; width: 22px; height: 22px; display: none; align-items: center; justify-content: center; font-size: 10px; border: 3px solid white;">0</span>
                    </div>
                    <div class="dropdown-menu dropdown-menu-end shadow-lg border-0" style="width: 380px; border-radius: 20px; padding: 0; overflow: hidden; margin-top: 15px;">
                        <div class="p-4 bg-dark text-white fw-bold">Recent Submissions</div>
                        <div id="notif-list-items" style="max-height: 400px; overflow-y: auto;"></div>
                        <div class="p-3 text-center bg-light border-top">
                            <a href="#" onclick="goToApplicantsFromNotif(event)" class="fw-bold text-decoration-none text-danger small">Show All Queue</a>
                        </div>
                    </div>
                </div>

                <!-- Admin Profile Info -->
                <div class="d-flex align-items-center gap-3 border-start ps-4">
                    <div class="text-end d-none d-md-block">
                        <span class="fw-bold small d-block" style="color: var(--dark-slate);">ROOT ADMIN</span>
                        <span class="text-success fw-bold" style="font-size: 0.7rem;">ACTIVE SESSION</span>
                    </div>
                    <div style="width: 55px; height: 55px; background: #f1f5f9; border-radius: 18px; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0;">
                        <i class="fas fa-shield-halved text-secondary fs-4"></i>
                    </div>
                </div>
            </div>
        </header>

        <div class="content-body">
            <!-- --- TAB 1: MODERN DASHBOARD --- -->
            <section id="dashboard-tab">
                <!-- Top Stats Bento Grid -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-red"><i class="fas fa-database"></i></div>
                            <h4>Database Total</h4>
                            <div class="value" id="stat-total">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-orange"><i class="fas fa-clock-rotate-left"></i></div>
                            <h4>Waiting Review</h4>
                            <div class="value text-warning" id="stat-pending">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-green"><i class="fas fa-user-check"></i></div>
                            <h4>Deployed Guards</h4>
                            <div class="value text-success" id="stat-approved">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-blue"><i class="fas fa-bolt-lightning"></i></div>
                            <h4>New Today</h4>
                            <div class="value text-primary" id="stat-today-count">0</div>
                        </div>
                    </div>
                </div>

                <!-- Visual Charts Grid -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="bento-box h-100">
                            <div class="d-flex justify-content-between align-items-center mb-5">
                                <h5 class="fw-bold m-0"><i class="fas fa-chart-simple me-3 text-danger"></i>Branch Deployment Stats</h5>
                                <span class="badge bg-light text-muted fw-bold px-3 py-2 border">Live Real-time</span>
                            </div>
                            <div style="height: 420px;"><canvas id="branchChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="bento-box rail-profile-card mb-4">
                            <div class="rail-profile-avatar"><i class="fas fa-user-tie"></i></div>
                            <h6 class="rail-profile-name mb-1">Aloha Admin</h6>
                            <p class="rail-profile-role mb-0">Recruitment Manager</p>
                            <button class="btn btn-light fw-bold mt-3 px-4 py-2 rounded-4 border" onclick="handleLogout()">
                                <i class="fas fa-arrow-right-from-bracket me-2 text-danger"></i>Quick Logout
                            </button>
                        </div>

                        <div class="bento-box mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold m-0"><i class="fas fa-comments me-2 text-danger"></i>Messages</h6>
                                <span class="small text-muted fw-bold">Live</span>
                            </div>
                            <div id="message-list" class="rail-list">
                                <div class="rail-item">
                                    <div class="rail-dot"></div>
                                    <div>
                                        <div class="fw-bold small">Recruitment System</div>
                                        <div class="text-muted small">No new message yet.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bento-box mb-4">
                            <h6 class="fw-bold mb-3"><i class="fas fa-chart-pie me-2 text-danger"></i>Status Ratio</h6>
                            <div style="height: 220px;"><canvas id="statusChart"></canvas></div>
                        </div>

                        <div class="bento-box">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold m-0"><i class="fas fa-activity me-2 text-danger"></i>Activity</h6>
                                <span class="small text-muted fw-bold">Today</span>
                            </div>
                            <div id="activity-log" class="rail-list" style="max-height: 220px; overflow-y: auto;">
                                <div class="rail-item">
                                    <div class="rail-dot"></div>
                                    <div class="text-muted small fw-bold">Awaiting activity logs...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- --- TAB 2: PERSONNEL MANAGEMENT --- -->
            <section id="applicants-tab" class="hidden">
                <div class="applicants-shell">
                    <div class="applicants-hero">
                        <div class="applicants-hero-icon"><i class="fas fa-user-check"></i></div>
                        <div>
                            <h3>Applicant Tracking</h3>
                            <p>Manage recruitment pipelines, reviews, and candidate processing.</p>
                        </div>
                    </div>

                    <div class="applicants-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="metric-total">0</div>
                            <div class="metric-label">Total Applicants</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="metric-male">0</div>
                            <div class="metric-label">Male</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="metric-female">0</div>
                            <div class="metric-label">Female</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="metric-month">0</div>
                            <div class="metric-label">This Month</div>
                        </div>
                    </div>

                    <div class="applicants-panel">
                        <div class="panel-search-row">
                            <div class="panel-search-wrap">
                                <i class="fas fa-magnifying-glass"></i>
                                <input type="text" id="searchInput" placeholder="Search name, email, or position..." oninput="updateUI()">
                            </div>
                            <select id="dateSort" onchange="updateUI()">
                                <option value="newest" selected>Date: Newest</option>
                                <option value="oldest">Date: Oldest</option>
                            </select>
                        </div>

                        <div class="panel-filter-row">
                            <button class="status-chip active" data-status-filter="all" onclick="setStatusFilter('all', this)"><i class="fas fa-table-cells-large"></i> All Applicants</button>
                            <button class="status-chip" data-status-filter="pending" onclick="setStatusFilter('pending', this)"><i class="fas fa-hourglass-half"></i> Pending</button>
                            <button class="status-chip" data-status-filter="for interview" onclick="setStatusFilter('for interview', this)"><i class="fas fa-calendar-check"></i> For Interview</button>
                            <button class="status-chip" data-status-filter="approved" onclick="setStatusFilter('approved', this)"><i class="fas fa-circle-check"></i> Hired</button>
                            <button class="status-chip" data-status-filter="rejected" onclick="setStatusFilter('rejected', this)"><i class="fas fa-circle-xmark"></i> Rejected</button>
                            <button class="status-chip" data-status-filter="blacklisted" onclick="setStatusFilter('blacklisted', this)"><i class="fas fa-user-slash"></i> Blacklisted</button>
                            <button class="register-btn" onclick="openManualAdd()"><i class="fas fa-plus-circle"></i> Register Personnel</button>
                        </div>

                        <div class="panel-select-row">
                            <label>
                                <input type="checkbox" id="select-all-applicants" onchange="toggleSelectAllApplicants(this)">
                                Select All Candidates on Page
                            </label>
                            <button id="bulk-trash-btn" class="bulk-trash-btn" onclick="bulkMoveToTrash()" disabled>Move Selected to Trash</button>
                        </div>

                        <div id="applicant-table-body" class="applicant-cards-grid"></div>
                    </div>
                </div>
            </section>

            <!-- --- TAB 3: LOCATION OPERATIONS --- -->
            <section id="branches-tab" class="hidden">
                <div class="mb-5">
                    <h3 class="fw-bold m-0">Branch Operations</h3>
                    <p class="text-muted">Overview of guards currently deployed at each station.</p>
                </div>
                <!-- Dynamic branch containers load here -->
                <div id="branch-accordion-container" class="row"></div>
            </section>

            <!-- --- TAB 4: BRANCH DIRECTORY --- -->
            <section id="branch-summary-tab" class="hidden">
                <div class="section-shell">
                    <div class="section-hero">
                        <div class="section-hero-icon"><i class="fas fa-building-shield"></i></div>
                        <div>
                            <h3>Branch Directory</h3>
                            <p>Branch-level totals for assigned, pending, and total applicants.</p>
                        </div>
                    </div>
                    <div id="branch-summary-grid" class="summary-grid"></div>
                </div>
            </section>

            <!-- --- TAB 5: AUDIT LOGS --- -->
            <section id="audit-tab" class="hidden">
                <div class="section-shell">
                    <div class="section-hero">
                        <div class="section-hero-icon"><i class="fas fa-file-shield"></i></div>
                        <div>
                            <h3>Audit Logs</h3>
                            <p>Latest applicant events, changes, and processing actions.</p>
                        </div>
                    </div>
                    <div class="section-card p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 audit-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Applicant</th>
                                        <th>Action</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- --- TAB 6: RECOVERY SYSTEM --- -->
            <section id="trash-tab" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h3 class="fw-bold m-0">Trash & Recovery</h3>
                        <p class="text-muted small mb-0"><i class="fas fa-circle-info me-2 text-primary"></i>Records here will be permanently erased after 3 days.</p>
                    </div>
                    <button id="bulk-delete-btn" class="btn btn-danger rounded-4 fw-bold px-4 py-3 shadow-sm" onclick="bulkDeleteTrash()"><i class="fas fa-dumpster-fire me-2"></i>Erase Selected Records</button>
                </div>
                <div class="bento-box p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light border-bottom">
                                <tr>
                                    <th class="ps-5" style="width: 80px;"><input type="checkbox" id="select-all-trash" class="form-check-input" onclick="toggleSelectAllTrash(this)"></th>
                                    <th class="text-muted fw-bold small text-uppercase">Personnel Name</th>
                                    <th class="text-muted fw-bold small text-uppercase">Last Position</th>
                                    <th class="text-muted fw-bold small text-uppercase">Reason/Tag</th>
                                    <th class="text-center text-muted fw-bold small text-uppercase">Recovery Ops</th>
                                </tr>
                            </thead>
                            <tbody id="trash-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- --- TAB 7: BLACKLIST --- -->
            <section id="blacklist-tab" class="hidden">
                <div class="section-shell">
                    <div class="section-hero">
                        <div class="section-hero-icon"><i class="fas fa-user-slash"></i></div>
                        <div>
                            <h3>Blacklisted Applicants</h3>
                            <p>Profiles flagged for invalid or naughty repeated applications.</p>
                        </div>
                    </div>
                    <div class="section-card p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 audit-table">
                                <thead>
                                    <tr>
                                        <th>Applicant</th>
                                        <th>Email</th>
                                        <th>Date Updated</th>
                                        <th>Status</th>
                                        <th class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="blacklist-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- --- TAB 8: USERS --- -->
            <section id="users-tab" class="hidden">
                <div class="section-shell">
                    <div class="section-hero">
                        <div class="section-hero-icon"><i class="fas fa-user-gear"></i></div>
                        <div>
                            <h3>System Users</h3>
                            <p>Current admin account and role configuration.</p>
                        </div>
                    </div>
                    <div id="users-grid" class="users-grid">
                        <article class="user-card">
                            <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
                            <div class="user-meta">
                                <h5>Admin Owner</h5>
                                <p id="users-admin-email">Loading email...</p>
                            </div>
                            <span class="user-role">ROOT ADMIN</span>
                        </article>
                    </div>
                </div>
            </section>

            <!-- --- TAB 9: SETTINGS --- -->
            <section id="settings-tab" class="hidden">
                <div class="section-shell">
                    <div class="section-hero">
                        <div class="section-hero-icon"><i class="fas fa-gears"></i></div>
                        <div>
                            <h3>Account Settings</h3>
                            <p>Change admin login email and password securely.</p>
                        </div>
                    </div>
                    <div class="section-card settings-card">
                        <div class="settings-current">
                            <span>Current Admin Email</span>
                            <strong id="settings-current-email">Loading...</strong>
                        </div>

                        <form id="account-settings-form" onsubmit="submitAdminSettings(event)">
                            <div class="settings-grid">
                                <div>
                                    <label class="settings-label" for="settings-current-password">Current Password *</label>
                                    <input id="settings-current-password" type="password" class="form-control" placeholder="Enter current password" required>
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-new-email">New Email</label>
                                    <input id="settings-new-email" type="email" class="form-control" placeholder="admin@example.com">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-new-password">New Password</label>
                                    <input id="settings-new-password" type="password" class="form-control" placeholder="Minimum 8 characters">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-confirm-password">Confirm New Password</label>
                                    <input id="settings-confirm-password" type="password" class="form-control" placeholder="Retype new password">
                                </div>
                            </div>

                            <p class="settings-help mb-3">
                                Enter at least one change: new email, new password, or both.
                            </p>

                            <button id="settings-save-btn" type="submit" class="btn btn-danger px-4 py-3 fw-bold rounded-4">
                                Save Account Changes
                            </button>
                        </form>
                        <div id="settings-feedback" class="settings-feedback" style="display: none;"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 13. SYSTEM CORE SCRIPT -->
    <script>
        /**
         * 1. DATABASE CONFIGURATION
         * Connecting to Supabase backend to fetch data.
         */
        const supabaseUrl = 'https://kkaelwhdcsgaodbhrxqt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYWVsd2hkY3NnYW9kYmhyeHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTA4NzksImV4cCI6MjA3MTc2Njg3OX0.wSFv1AZgZDXjGHiIwOHyWzqTDk0v6NbR4-2r90iF9ok';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let masterData = [];
        let activeStatusFilter = 'all';
        let selectedApplicantIds = new Set();
        let currentAdminEmail = '';
        const LONG_WAIT_DAYS = 7;
        const branchOptions = ["Manila Main", "Quezon City", "Makati Hub", "Davao Branch", "Cebu Office"];
        const ADMIN_LOCK_AUDIT_KEY = 'aloha-admin-lock-audit-state';
        const ADMIN_LOCK_POLL_MS = 60 * 1000;
        let adminLockStatusTimer = null;

        /**
         * 2. SIDEBAR NAVIGATION LOGIC
         */
        function toggleSidebarDesktop() {
            const sidebar = document.getElementById('sidebar');
            const main = document.querySelector('.main-content');
            sidebar.classList.toggle('collapsed');
            main.classList.toggle('sidebar-collapsed');
            // Refresh charts after resizing sidebar for visual consistency
            setTimeout(() => { if(window.bChart) renderCharts(); }, 500);
        }

        function toggleSidebarMobile() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function switchTab(id, el) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item[data-tab]').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.remove('hidden');
            el.classList.add('active');
            const title = el.getAttribute('data-title') || el.innerText;
            document.getElementById('current-title').innerText = title.toUpperCase();
            if (id === 'settings-tab' || id === 'users-tab') loadAdminSettingsProfile();
            if (id === 'audit-tab') renderAuditLogs();
            if (id === 'branch-summary-tab') renderBranchSummary();
            if (id === 'blacklist-tab') renderBlacklistedRows();
            if (window.innerWidth <= 992) document.getElementById('sidebar').classList.remove('open');
        }

        function goToApplicantsFromNotif(event) {
            event.preventDefault();
            const applicantsNav = document.querySelector('.nav-item[data-tab="applicants-tab"]');
            if (!applicantsNav) return;
            switchTab('applicants-tab', applicantsNav);
        }

        function getAdminLockAuditState() {
            try {
                const parsed = JSON.parse(localStorage.getItem(ADMIN_LOCK_AUDIT_KEY) || '{}');
                return {
                    wasLocked: Boolean(parsed.wasLocked),
                    lastSeenLockUntil: parsed.lastSeenLockUntil ? String(parsed.lastSeenLockUntil) : '',
                    lastUnlockToken: parsed.lastUnlockToken ? String(parsed.lastUnlockToken) : ''
                };
            } catch (_) {
                return {
                    wasLocked: false,
                    lastSeenLockUntil: '',
                    lastUnlockToken: ''
                };
            }
        }

        function setAdminLockAuditState(state) {
            localStorage.setItem(
                ADMIN_LOCK_AUDIT_KEY,
                JSON.stringify({
                    wasLocked: Boolean(state.wasLocked),
                    lastSeenLockUntil: state.lastSeenLockUntil || '',
                    lastUnlockToken: state.lastUnlockToken || ''
                })
            );
        }

        async function monitorAdminLoginLockStatus() {
            try {
                const response = await fetch('/api/admin-login-guard', { method: 'GET' });
                const result = await response.json().catch(() => ({}));
                if (!response.ok || !result?.success) return;

                const isLocked = Boolean(result.locked);
                const lockUntil = result.lockedUntil ? String(result.lockedUntil) : '';
                const state = getAdminLockAuditState();
                let unlockToken = '';

                if (!isLocked) {
                    // Prefer deterministic lock token so we log unlock exactly once per lock window.
                    unlockToken = lockUntil || state.lastSeenLockUntil || (result.justUnlocked ? 'just-unlocked' : '');
                }

                if (
                    !isLocked &&
                    (result.justUnlocked || state.wasLocked) &&
                    unlockToken &&
                    state.lastUnlockToken !== unlockToken
                ) {
                    logActivity('Security: Admin login lockout expired and was automatically lifted.');
                    state.lastUnlockToken = unlockToken;
                }

                state.wasLocked = isLocked;
                state.lastSeenLockUntil = lockUntil || state.lastSeenLockUntil;
                if (isLocked && lockUntil) {
                    state.lastSeenLockUntil = lockUntil;
                }
                setAdminLockAuditState(state);
            } catch (_) {}
        }

        /**
         * 3. DATA FETCHING & STATE MANAGEMENT
         */
        async function fetchData() {
            const { data, error } = await _supabase.from('applicants').select('*').order('created_at', { ascending: false });
            if (error) return console.error("Database Error:", error);
            
            masterData = data;
            
            // AUTOMATIC TRASH PURGE: Delete rejected records older than 3 days.
            const now = new Date();
            const trashItems = masterData.filter(a => a.status?.toLowerCase() === 'rejected');
            for (let item of trashItems) {
                const rejectedDate = new Date(item.updated_at || item.created_at);
                if (Math.ceil((now - rejectedDate) / (1000 * 60 * 60 * 24)) >= 3) {
                    await _supabase.from('applicants').delete().eq('id', item.id);
                }
            }
            
            updateUI(); // Refresh the visual interface
        }

        /**
         * 4. UI RE-RENDERING ENGINE
         */
        function legacyUpdateUI() {
            const pendingApps = masterData.filter(a => a.status?.toLowerCase() === 'pending');
            const now = new Date();
            const todayApps = masterData.filter(a => (now - new Date(a.created_at)) < (24 * 60 * 60 * 1000));
            
            // Update Dashboard Stat Counters
            document.getElementById('stat-total').innerText = masterData.length;
            document.getElementById('stat-pending').innerText = pendingApps.length;
            document.getElementById('stat-approved').innerText = masterData.filter(a => a.status?.toLowerCase() === 'approved').length;
            document.getElementById('stat-today-count').innerText = todayApps.length;
            
            // Handle Notification System
            const badge = document.getElementById('notif-badge');
            const notifList = document.getElementById('notif-list-items');
            const messageList = document.getElementById('message-list');
            if(pendingApps.length > 0) {
                badge.innerText = pendingApps.length;
                badge.style.display = 'flex';
                notifList.innerHTML = pendingApps.slice(0, 5).map(app => `
                    <a class="p-3 border-bottom d-block text-decoration-none hover-light" style="cursor: pointer;" onclick="window.location.href='view-applicant.html?id=${app.id}'">
                        <div class="fw-bold text-danger small">${app.first_name} ${app.last_name}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Submitted for: ${app.desired_position}</div>
                    </a>`).join('');
            } else {
                badge.style.display = 'none';
                notifList.innerHTML = '<div class="p-5 text-center text-muted small fw-bold">Queue is currently clear.</div>';
            }

            if (messageList) {
                const latest = masterData.slice(0, 4);
                if (latest.length === 0) {
                    messageList.innerHTML = `
                        <div class="rail-item">
                            <div class="rail-dot"></div>
                            <div class="text-muted small fw-bold">No message yet.</div>
                        </div>`;
                } else {
                    messageList.innerHTML = latest.map(app => `
                        <div class="rail-item">
                            <div class="rail-dot"></div>
                            <div>
                                <div class="fw-bold small">${app.first_name} ${app.last_name}</div>
                                <div class="text-muted small">${app.status || 'Pending'} - ${app.desired_position || 'N/A'}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Table Filter and Search Logic
            const filterVal = document.getElementById('statusFilter').value;
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            let filtered = masterData.filter(a => a.status?.toLowerCase() !== 'rejected');

            if (filterVal === 'pending') filtered = filtered.filter(a => a.status?.toLowerCase() === 'pending');
            else if (filterVal === 'approved') filtered = filtered.filter(a => a.status?.toLowerCase() === 'approved');

            if (searchVal) filtered = filtered.filter(a => (a.first_name + ' ' + a.last_name).toLowerCase().includes(searchVal));

            // Execute rendering sub-functions
            legacyRenderTableRows(filtered);
            renderCharts();
            renderAccordions();
            renderTrashBin();
        }

        /**
         * 5. LIST RENDERING FUNCTIONS
         */
        function legacyRenderTableRows(list) {
            const tbody = document.getElementById('applicant-table-body');
            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-5 fw-bold fs-5">No records matching the filter.</td></tr>`;
                return;
            }
            tbody.innerHTML = list.map(app => {
                const dateStr = new Date(app.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return `
                    <tr style="transition: 0.2s;">
                        <td class="ps-5 py-4">
                            <div class="fw-bold" style="color: var(--dark-slate);">${app.first_name} ${app.last_name}</div>
                            <div class="text-muted" style="font-size: 0.75rem; font-weight: 700;">REGISTRATION: ${dateStr}</div>
                        </td>
                        <td class="fw-bold text-secondary" style="font-size: 0.95rem;">${app.desired_position || 'Not Assigned'}</td>
                        <td><span class="badge-${app.status?.toLowerCase()}">${app.status.toUpperCase()}</span></td>
                        <td class="text-center">
                            <button class="btn-action btn-view me-2" onclick="window.location.href='view-applicant.html?id=${app.id}'" title="View Identity"><i class="fas fa-eye"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteApp('${app.id}')" title="Move to Trash Bin"><i class="fas fa-trash-can"></i></button>
                        </td>
                    </tr>`;
            }).join('');
        }

        function renderAccordions() {
            const container = document.getElementById('branch-accordion-container');
            container.innerHTML = branchOptions.map(branch => {
                const guards = masterData.filter(a => a.assigned_branch === branch && a.status === 'Approved');
                return `
                    <div class="col-md-6 mb-4">
                        <div class="branch-accordion shadow-sm">
                            <div class="accordion-header-custom bg-white" onclick="this.nextElementSibling.classList.toggle('active')">
                                <span class="d-flex align-items-center"><i class="fas fa-location-dot text-danger me-3 fs-5"></i> ${branch}</span>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="badge bg-light text-secondary fw-bold border" style="font-size: 0.75rem; padding: 6px 15px; border-radius: 10px;">${guards.length} ON SITE</span>
                                    <i class="fas fa-chevron-down small text-muted"></i>
                                </div>
                            </div>
                            <div class="accordion-content">
                                <div class="p-3 bg-white">
                                    ${guards.map(g => `
                                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-light">
                                            <span class="small fw-bold text-dark"><i class="fas fa-id-card-clip me-3 text-secondary"></i> ${g.first_name} ${g.last_name}</span>
                                            <button onclick="unassign('${g.id}')" class="btn btn-link btn-sm text-danger fw-bold p-0 text-decoration-none" style="font-size: 0.7rem;">
                                                UNASSIGN
                                            </button>
                                        </div>`).join('') || '<div class="text-center py-5 text-muted small fw-bold opacity-50">LOCATION CURRENTLY VACANT</div>'}
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderTrashBin() {
            const tbody = document.getElementById('trash-table-body');
            const trashList = masterData.filter(a => a.status?.toLowerCase() === 'rejected');
            document.getElementById('select-all-trash').checked = false;
            const bulkBtn = document.getElementById('bulk-delete-btn');
            if (bulkBtn) bulkBtn.style.visibility = 'hidden';

            if(trashList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-5 fw-bold fs-5">Trash repository is empty.</td></tr>`;
                return;
            }

            tbody.innerHTML = trashList.map(app => `
                <tr>
                    <td class="ps-5 py-4"><input type="checkbox" class="trash-check form-check-input" data-id="${app.id}" onclick="updateTrashBulkUI()"></td>
                    <td class="fw-bold text-dark">${app.first_name} ${app.last_name}</td>
                    <td class="small fw-bold text-secondary">${app.desired_position}</td>
                    <td><span class="badge-rejected">DELETED ITEM</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light text-primary me-2 fw-bold px-4 py-2 border rounded-3" onclick="restoreApplicant('${app.id}')">RESTORE</button>
                        <button class="btn btn-sm btn-danger fw-bold px-4 py-2 rounded-3 shadow-sm" onclick="deleteApp('${app.id}')">ERASE</button>
                    </td>
                </tr>`).join('');
        }

        /**
         * 6. SYSTEM ACTIONS & CONFIRMATION OVERLAYS
         */
        async function askModal(title, text, confirmText = "Confirm") {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModal');
                const iconDiv = document.getElementById('modalIcon');
                const confirmBtn = document.getElementById('confirmBtn');
                const icon = iconDiv.querySelector('i');
                
                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalText').innerText = text;
                confirmBtn.innerText = confirmText;
                
                // Visual Switch for icons based on title
                if(title.includes('Restore')) {
                    icon.className = 'fas fa-arrows-rotate';
                    iconDiv.style.color = '#10b981';
                    confirmBtn.style.background = '#10b981'; 
                } else if (title.includes('Logout')) {
                    icon.className = 'fas fa-power-off';
                    iconDiv.style.color = 'var(--primary-red)';
                    confirmBtn.style.background = 'var(--primary-red)';
                } else {
                    icon.className = 'fas fa-circle-exclamation';
                    iconDiv.style.color = 'var(--primary-red)';
                    confirmBtn.style.background = 'var(--primary-red)';
                }

                overlay.classList.add('active');
                confirmBtn.onclick = () => { overlay.classList.remove('active'); resolve(true); };
                document.getElementById('cancelBtn').onclick = () => { overlay.classList.remove('active'); resolve(false); };
            });
        }

        async function deleteApp(id) {
            const yes = await askModal("Erase Record?", "Are you sure? This personnel will be permanently deleted.", "Yes, Erase");
            if (yes) {
                await _supabase.from('applicants').delete().eq('id', id);
                logActivity(`System Log: Permanently erased record ID ${id}`);
                fetchData();
            }
        }

        async function unassign(id) {
            const yes = await askModal("Unassign Personnel?", "Remove this guard from the branch? They will return to the Pending queue.", "Unassign Now");
            if (yes) {
                await _supabase.from('applicants').update({ assigned_branch: null, status: 'Pending' }).eq('id', id);
                logActivity(`Action: Unassigned personnel ID ${id}`);
                fetchData();
            }
        }

        async function restoreApplicant(id) {
            const yes = await askModal("Restore Identity?", "Move this personnel back to the active queue?", "Yes, Restore");
            if(yes) {
                await _supabase.from('applicants').update({ status: 'Pending' }).eq('id', id);
                logActivity(`Action: Restored rejected ID ${id}`);
                fetchData();
            }
        }

        async function handleLogout() {
            if(await askModal("Logout Session?", "Are you ready to end your session?", "Logout Now")) {
                await _supabase.auth.signOut();
                window.location.href = 'AdminLogin.html';
            }
        }

        /**
         * 7. BULK OPERATION LOGIC
         */
        function toggleSelectAllTrash(source) { 
            document.querySelectorAll('.trash-check').forEach(cb => cb.checked = source.checked); 
            updateTrashBulkUI(); 
        }

        function updateTrashBulkUI() { 
            const count = document.querySelectorAll('.trash-check:checked').length; 
            const bulkBtn = document.getElementById('bulk-delete-btn');
            if (bulkBtn) bulkBtn.style.visibility = count > 0 ? 'visible' : 'hidden'; 
        }

        async function bulkDeleteTrash() {
            const ids = Array.from(document.querySelectorAll('.trash-check:checked')).map(cb => cb.getAttribute('data-id'));
            if(await askModal("Purge Trash?", `Permanently delete ${ids.length} selected records?`, "Purge All")) {
                await _supabase.from('applicants').delete().in('id', ids);
                logActivity(`Bulk Action: Purged ${ids.length} items.`);
                fetchData();
            }
        }

        /**
         * 8. MANUAL REGISTRATION FLOW
         */
        function openManualAdd() { document.getElementById('manualAddModal').classList.add('active'); }
        function closeManualAdd() { document.getElementById('manualAddModal').classList.remove('active'); }

        async function saveManualEmployee() {
            const fname = document.getElementById('m_first_name').value.trim();
            const lname = document.getElementById('m_last_name').value.trim();
            if(!fname || !lname) return alert("Full name is required.");
            
            await _supabase.from('applicants').insert([{ 
                first_name: fname, 
                last_name: lname, 
                desired_position: document.getElementById('m_position').value, 
                assigned_branch: document.getElementById('m_branch').value || null, 
                status: document.getElementById('m_branch').value ? 'Approved' : 'Pending' 
            }]);
            
            logActivity(`Admin: Registered ${fname} ${lname}`);
            closeManualAdd(); 
            fetchData();
        }

        function logActivity(msg) {
            const log = document.getElementById('activity-log');
            const div = document.createElement('div'); 
            div.className = 'p-3 bg-light rounded-4 mb-3 small fw-bold border-start border-danger border-4';
            div.innerHTML = `<div>${msg}</div><div class="text-muted opacity-50 mt-1" style="font-size: 0.65rem;">TIME: ${new Date().toLocaleTimeString()}</div>`;
            log.prepend(div);
        }

        /**
         * 9. ANALYTICS & CHART RENDERING
         */
        function renderCharts() {
            const ctx1 = document.getElementById('branchChart').getContext('2d');
            const ctx2 = document.getElementById('statusChart').getContext('2d');
            
            // Avoid double rendering errors
            if (window.bChart) window.bChart.destroy();
            if (window.sChart) window.sChart.destroy();
            
            // Bar Chart: Branch Counts
            window.bChart = new Chart(ctx1, { 
                type: 'bar', 
                data: { 
                    labels: branchOptions, 
                    datasets: [{ 
                        label: 'Personnel Count', 
                        data: branchOptions.map(b => masterData.filter(a => a.assigned_branch === b).length), 
                        backgroundColor: '#D2042D', 
                        borderRadius: 14,
                        barThickness: 50 
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, border: {display: false} }, 
                        x: { grid: { display: false }, border: {display: false} } 
                    } 
                } 
            });
            
            // Doughnut Chart: Ratio
            window.sChart = new Chart(ctx2, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Pending', 'Approved', 'Rejected'], 
                    datasets: [{ 
                        data: [
                            masterData.filter(a => a.status==='Pending').length, 
                            masterData.filter(a => a.status==='Approved').length, 
                            masterData.filter(a => a.status==='Rejected').length
                        ], 
                        backgroundColor: ['#f59e0b', '#10b981', '#ef4444'], 
                        borderWidth: 10, 
                        borderColor: '#fff',
                        hoverOffset: 15 
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false, 
                    cutout: '82%', 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { padding: 30, usePointStyle: true, font: { size: 12, weight: 800 } } 
                        } 
                    } 
                } 
            });
        }

        // --- Applicants View (Reference Layout Override) ---
        function updateUI() {
            const pendingApps = masterData.filter(a => a.status?.toLowerCase() === 'pending');
            const now = new Date();
            const todayApps = masterData.filter(a => (now - new Date(a.created_at)) < (24 * 60 * 60 * 1000));
            const longWaitApps = pendingApps.filter((app) => getWaitingDays(app) >= LONG_WAIT_DAYS);

            // Dashboard counters
            document.getElementById('stat-total').innerText = masterData.length;
            document.getElementById('stat-pending').innerText = pendingApps.length;
            document.getElementById('stat-approved').innerText = masterData.filter(a => a.status?.toLowerCase() === 'approved').length;
            document.getElementById('stat-today-count').innerText = todayApps.length;

            // Notification feed
            const badge = document.getElementById('notif-badge');
            const notifList = document.getElementById('notif-list-items');
            const messageList = document.getElementById('message-list');
            if (pendingApps.length > 0) {
                badge.innerText = pendingApps.length;
                badge.style.display = 'flex';
                const longWaitBanner = longWaitApps.length > 0
                    ? `<div class="p-3 border-bottom bg-warning-subtle text-dark fw-bold small">
                        <i class="fas fa-bell me-2 text-danger"></i>${longWaitApps.length} applicant(s) waiting more than ${LONG_WAIT_DAYS} days.
                      </div>`
                    : '';
                const listHtml = pendingApps.slice(0, 7).map(app => `
                    <a class="p-3 border-bottom d-block text-decoration-none hover-light" style="cursor: pointer;" onclick="window.location.href='view-applicant.html?id=${app.id}'">
                        <div class="fw-bold text-danger small">${app.first_name} ${app.last_name}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            Submitted for: ${app.desired_position} ${getWaitingDays(app) >= LONG_WAIT_DAYS ? `- Waiting ${getWaitingDays(app)} days` : ''}
                        </div>
                    </a>`).join('');
                notifList.innerHTML = `${longWaitBanner}${listHtml}`;
            } else {
                badge.style.display = 'none';
                notifList.innerHTML = '<div class="p-5 text-center text-muted small fw-bold">Queue is currently clear.</div>';
            }

            maybeNotifyLongWaitByEmail(longWaitApps);

            if (messageList) {
                const latest = masterData.slice(0, 4);
                if (latest.length === 0) {
                    messageList.innerHTML = `
                        <div class="rail-item">
                            <div class="rail-dot"></div>
                            <div class="text-muted small fw-bold">No message yet.</div>
                        </div>`;
                } else {
                    messageList.innerHTML = latest.map(app => `
                        <div class="rail-item">
                            <div class="rail-dot"></div>
                            <div>
                                <div class="fw-bold small">${app.first_name} ${app.last_name}</div>
                                <div class="text-muted small">${app.status || 'Pending'} - ${app.desired_position || 'N/A'}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            updateApplicantMetrics();

            const searchInput = document.getElementById('searchInput');
            const sortInput = document.getElementById('dateSort');
            const searchVal = (searchInput?.value || '').trim().toLowerCase();
            const sortVal = sortInput?.value || 'newest';

            let filtered = masterData.slice();
            if (activeStatusFilter === 'all') {
                filtered = filtered.filter(a => {
                    const s = String(a.status || '').toLowerCase();
                    return s !== 'rejected' && s !== 'blacklisted';
                });
            } else {
                filtered = filtered.filter(a => a.status?.toLowerCase() === activeStatusFilter);
            }

            if (searchVal) {
                filtered = filtered.filter(a => {
                    const fullName = `${a.first_name || ''} ${a.last_name || ''}`.toLowerCase();
                    const pos = `${a.desired_position || ''}`.toLowerCase();
                    const email = `${a.email || ''}`.toLowerCase();
                    return fullName.includes(searchVal) || pos.includes(searchVal) || email.includes(searchVal);
                });
            }

            filtered.sort((a, b) => {
                const aDate = new Date(a.created_at || 0).getTime();
                const bDate = new Date(b.created_at || 0).getTime();
                return sortVal === 'oldest' ? aDate - bDate : bDate - aDate;
            });

            renderTableRows(filtered);
            renderCharts();
            renderAccordions();
            renderBranchSummary();
            renderAuditLogs();
            renderUsers();
            renderTrashBin();
            renderBlacklistedRows();
        }

        function renderTableRows(list) {
            const container = document.getElementById('applicant-table-body');
            const selectAllInput = document.getElementById('select-all-applicants');
            if (!container) return;

            if (selectAllInput) selectAllInput.checked = false;
            selectedApplicantIds.clear();
            updateApplicantBulkUI();

            if (list.length === 0) {
                container.innerHTML = `<div class="empty-applicants">No records matching this filter.</div>`;
                return;
            }

            container.innerHTML = list.map(app => {
                const dateStr = new Date(app.created_at).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
                const statusInfo = getStatusInfo(app.status);
                return `
                    <article class="applicant-card">
                        <div class="applicant-card-head">
                            <label class="applicant-select-wrap">
                                <input type="checkbox" class="app-select" data-id="${app.id}" onchange="toggleApplicantSelection('${app.id}', this)">
                            </label>
                            <div class="candidate-icon"><i class="fas fa-id-badge"></i></div>
                            <div class="candidate-main">
                                <h5>${app.first_name || ''} ${app.last_name || ''}</h5>
                                <p><i class="fas fa-briefcase"></i> ${app.desired_position || 'Security Guard'}</p>
                            </div>
                            <span class="status-tag ${statusInfo.className}">${statusInfo.label}</span>
                        </div>
                        <div class="applicant-contact-box">
                            <div><i class="fas fa-envelope"></i> ${app.email || 'No email'}</div>
                            <div><i class="fas fa-phone"></i> ${app.phone || 'No phone'}</div>
                            <div><i class="fas fa-calendar-day"></i> Applied: ${dateStr}</div>
                        </div>
                        <div class="applicant-actions">
                            <button class="card-btn card-btn-view" onclick="window.location.href='view-applicant.html?id=${app.id}'">View Profile</button>
                            ${statusInfo.className === 'status-blacklisted'
                                ? `<button class="card-btn card-btn-warning" onclick="unblacklistApplicant('${app.id}')">Remove Blacklist</button>`
                                : `<button class="card-btn card-btn-trash" onclick="moveToTrash('${app.id}')">Move to Trash</button>`}
                        </div>
                    </article>`;
            }).join('');
        }

        function getStatusInfo(statusValue) {
            const status = String(statusValue || 'Pending').toLowerCase();
            if (status === 'approved' || status === 'hired') return { label: 'HIRED', className: 'status-hired' };
            if (status === 'for interview' || status === 'interview') return { label: 'FOR INTERVIEW', className: 'status-interview' };
            if (status === 'rejected') return { label: 'REJECTED', className: 'status-rejected' };
            if (status === 'blacklisted') return { label: 'BLACKLISTED', className: 'status-blacklisted' };
            return { label: 'PENDING', className: 'status-pending' };
        }

        function normalizeGender(raw) {
            const val = String(raw || '').trim().toLowerCase();
            if (val === 'm' || val === 'male') return 'male';
            if (val === 'f' || val === 'female') return 'female';
            return '';
        }

        function updateApplicantMetrics() {
            const activeApplicants = masterData.filter(a => {
                const s = String(a.status || '').toLowerCase();
                return s !== 'rejected' && s !== 'blacklisted';
            });
            const now = new Date();
            const monthCount = activeApplicants.filter(a => {
                const d = new Date(a.created_at || 0);
                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            }).length;
            const maleCount = activeApplicants.filter(a => normalizeGender(a.gender || a.sex) === 'male').length;
            const femaleCount = activeApplicants.filter(a => normalizeGender(a.gender || a.sex) === 'female').length;

            const metricTotal = document.getElementById('metric-total');
            const metricMale = document.getElementById('metric-male');
            const metricFemale = document.getElementById('metric-female');
            const metricMonth = document.getElementById('metric-month');
            if (metricTotal) metricTotal.innerText = activeApplicants.length;
            if (metricMale) metricMale.innerText = maleCount;
            if (metricFemale) metricFemale.innerText = femaleCount;
            if (metricMonth) metricMonth.innerText = monthCount;
        }

        function setStatusFilter(value, btn) {
            activeStatusFilter = value;
            document.querySelectorAll('.status-chip').forEach(chip => chip.classList.remove('active'));
            btn.classList.add('active');
            updateUI();
        }

        function toggleSelectAllApplicants(source) {
            document.querySelectorAll('.app-select').forEach(cb => {
                cb.checked = source.checked;
                const id = cb.getAttribute('data-id');
                if (source.checked) selectedApplicantIds.add(id);
                else selectedApplicantIds.delete(id);
            });
            updateApplicantBulkUI();
        }

        function toggleApplicantSelection(id, checkbox) {
            if (checkbox.checked) selectedApplicantIds.add(id);
            else selectedApplicantIds.delete(id);

            const allChecks = Array.from(document.querySelectorAll('.app-select'));
            const allSelected = allChecks.length > 0 && allChecks.every(cb => cb.checked);
            const selectAll = document.getElementById('select-all-applicants');
            if (selectAll) selectAll.checked = allSelected;
            updateApplicantBulkUI();
        }

        function updateApplicantBulkUI() {
            const bulkBtn = document.getElementById('bulk-trash-btn');
            if (!bulkBtn) return;
            bulkBtn.disabled = selectedApplicantIds.size === 0;
            bulkBtn.innerText = selectedApplicantIds.size > 0
                ? `Move Selected to Trash (${selectedApplicantIds.size})`
                : 'Move Selected to Trash';
        }

        async function moveToTrash(id) {
            const yes = await askModal("Move to Trash?", "This applicant will be transferred to Trash Bin.", "Move to Trash");
            if (!yes) return;
            await _supabase.from('applicants').update({ status: 'Rejected', updated_at: new Date().toISOString() }).eq('id', id);
            logActivity(`Action: Moved applicant ID ${id} to trash.`);
            fetchData();
        }

        async function bulkMoveToTrash() {
            const ids = Array.from(selectedApplicantIds);
            if (ids.length === 0) return;
            const yes = await askModal("Move Selected Applicants?", `Move ${ids.length} selected applicants to Trash Bin?`, "Confirm");
            if (!yes) return;
            await _supabase
                .from('applicants')
                .update({ status: 'Rejected', updated_at: new Date().toISOString() })
                .in('id', ids);
            logActivity(`Bulk Action: Moved ${ids.length} applicants to trash.`);
            selectedApplicantIds.clear();
            fetchData();
        }

        function getWaitingDays(app) {
            const created = new Date(app?.created_at || 0);
            if (Number.isNaN(created.getTime())) return 0;
            return Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
        }

        async function maybeNotifyLongWaitByEmail(longWaitApps) {
            if (!Array.isArray(longWaitApps) || longWaitApps.length === 0) return;
            const today = new Date().toISOString().slice(0, 10);
            const signature = longWaitApps
                .map((a) => `${a.id}:${getWaitingDays(a)}`)
                .sort()
                .join('|');
            const key = 'aloha-long-wait-alert';

            try {
                const previous = JSON.parse(localStorage.getItem(key) || '{}');
                if (previous.date === today && previous.signature === signature) return;
            } catch (_) {}

            try {
                await fetch('/api/admin-alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'long_wait',
                        thresholdDays: LONG_WAIT_DAYS,
                        applicants: longWaitApps.slice(0, 30).map((app) => ({
                            id: app.id,
                            name: `${app.first_name || ''} ${app.last_name || ''}`.trim(),
                            email: app.email || '',
                            position: app.desired_position || '',
                            daysWaiting: getWaitingDays(app),
                            created_at: app.created_at || null
                        }))
                    })
                });
                localStorage.setItem(key, JSON.stringify({ date: today, signature }));
            } catch (_) {}
        }

        function formatDateTime(value) {
            if (!value) return 'N/A';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return 'N/A';
            return d.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getAuditAction(app) {
            const status = String(app.status || '').toLowerCase();
            if (status === 'approved') return app.assigned_branch ? `Assigned to ${app.assigned_branch}` : 'Approved';
            if (status === 'rejected') return 'Moved to Trash / Rejected';
            if (status === 'blacklisted') return 'Flagged as Blacklisted';
            if (status === 'for interview') return 'Queued for Interview';
            return 'Pending Review';
        }

        function renderAuditLogs() {
            const tbody = document.getElementById('audit-table-body');
            if (!tbody) return;

            if (!masterData.length) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4 fw-bold">No activity logs yet.</td></tr>`;
                return;
            }

            const rows = masterData
                .slice()
                .sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0))
                .slice(0, 30);

            tbody.innerHTML = rows.map(app => `
                <tr>
                    <td>${formatDateTime(app.updated_at || app.created_at)}</td>
                    <td class="fw-bold">${app.first_name || ''} ${app.last_name || ''}</td>
                    <td>${getAuditAction(app)}</td>
                    <td><span class="status-tag ${getStatusInfo(app.status).className}">${getStatusInfo(app.status).label}</span></td>
                </tr>
            `).join('');
        }

        function renderBlacklistedRows() {
            const tbody = document.getElementById('blacklist-table-body');
            if (!tbody) return;

            const blacklisted = masterData
                .filter((a) => String(a.status || '').toLowerCase() === 'blacklisted')
                .sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0));

            if (!blacklisted.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4 fw-bold">No blacklisted applicants.</td></tr>`;
                return;
            }

            tbody.innerHTML = blacklisted.map((app) => `
                <tr>
                    <td class="fw-bold">${app.first_name || ''} ${app.last_name || ''}</td>
                    <td>${app.email || 'N/A'}</td>
                    <td>${formatDateTime(app.updated_at || app.created_at)}</td>
                    <td><span class="status-tag status-blacklisted">BLACKLISTED</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light fw-bold border" onclick="unblacklistApplicant('${app.id}')">Remove Blacklist</button>
                    </td>
                </tr>
            `).join('');
        }

        async function unblacklistApplicant(id) {
            const yes = await askModal("Remove Blacklist?", "This applicant will return to Pending status.", "Remove");
            if (!yes) return;
            await _supabase.from('applicants').update({ status: 'Pending', updated_at: new Date().toISOString() }).eq('id', id);
            logActivity(`Action: Removed blacklist for applicant ID ${id}`);
            fetchData();
        }

        function renderBranchSummary() {
            const container = document.getElementById('branch-summary-grid');
            if (!container) return;

            container.innerHTML = branchOptions.map(branch => {
                const list = masterData.filter(a => a.assigned_branch === branch);
                const hired = list.filter(a => String(a.status || '').toLowerCase() === 'approved').length;
                const pending = list.filter(a => String(a.status || '').toLowerCase() === 'pending').length;
                return `
                    <article class="summary-card">
                        <h5>${branch}</h5>
                        <div class="summary-metrics">
                            <div><span>Total</span><strong>${list.length}</strong></div>
                            <div><span>Assigned</span><strong>${hired}</strong></div>
                            <div><span>Pending</span><strong>${pending}</strong></div>
                        </div>
                    </article>`;
            }).join('');
        }

        function renderUsers() {
            const emailEl = document.getElementById('users-admin-email');
            if (emailEl) emailEl.innerText = currentAdminEmail || 'Not configured';
            const settingsEmailEl = document.getElementById('settings-current-email');
            if (settingsEmailEl) settingsEmailEl.innerText = currentAdminEmail || 'Not configured';
        }

        function showSettingsFeedback(type, message) {
            const box = document.getElementById('settings-feedback');
            if (!box) return;
            box.style.display = 'block';
            box.className = `settings-feedback ${type}`;
            box.innerText = message;
        }

        async function loadAdminSettingsProfile() {
            try {
                const response = await fetch('/api/admin-account-settings');
                const result = await response.json().catch(() => ({}));
                if (response.ok && result?.success) {
                    currentAdminEmail = result.email || currentAdminEmail;
                }
            } catch (_) {}
            renderUsers();
        }

        async function submitAdminSettings(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('settings-current-password')?.value || '';
            const newEmail = (document.getElementById('settings-new-email')?.value || '').trim();
            const newPassword = document.getElementById('settings-new-password')?.value || '';
            const confirmPassword = document.getElementById('settings-confirm-password')?.value || '';
            const saveBtn = document.getElementById('settings-save-btn');

            if (!currentPassword) {
                showSettingsFeedback('error', 'Current password is required.');
                return;
            }
            if (!newEmail && !newPassword) {
                showSettingsFeedback('error', 'Set a new email or new password first.');
                return;
            }
            if (newPassword && newPassword !== confirmPassword) {
                showSettingsFeedback('error', 'New password and confirmation do not match.');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerText = 'Saving...';
            try {
                const response = await fetch('/api/admin-account-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword,
                        newEmail: newEmail || undefined,
                        newPassword: newPassword || undefined
                    })
                });
                const result = await response.json().catch(() => ({}));
                if (!response.ok || !result?.success) {
                    throw new Error(result?.error || 'Failed to update account settings.');
                }

                currentAdminEmail = result.email || currentAdminEmail;
                renderUsers();
                document.getElementById('settings-current-password').value = '';
                document.getElementById('settings-new-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
                document.getElementById('settings-new-email').value = '';
                showSettingsFeedback('success', 'Admin account settings updated successfully.');
            } catch (err) {
                showSettingsFeedback('error', err.message || 'Unable to save account settings.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = 'Save Account Changes';
            }
        }

        // INIT SYSTEM
        monitorAdminLoginLockStatus();
        if (adminLockStatusTimer) clearInterval(adminLockStatusTimer);
        adminLockStatusTimer = setInterval(monitorAdminLoginLockStatus, ADMIN_LOCK_POLL_MS);
        fetchData();
        loadAdminSettingsProfile();
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

